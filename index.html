<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>专注时间管理</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
 body { font-family: Arial; margin:0; padding:0; background:#f5f5f5; }
 header { background:#4a6cf7; color:#fff; padding:20px; font-size:22px; text-align:center; }
 .container { padding:20px; }
 input, button, select { padding:10px; margin:5px 0; width:100%; }
 .task { background:#fff; padding:15px; border-radius:10px; margin-bottom:10px; }
 #focusMode { position:fixed; top:0; left:0; width:100%; height:100%; background:#000c; display:none; color:#fff; text-align:center; padding-top:20%; font-size:40px; }
</style>
</head>
<body>
<header>专注时间管理</header>
<div class="container">
 <h3>登录</h3>
 <input id="username" placeholder="输入你的名字" />
 <button id="loginBtn">登录</button>
 <div id="userDisplay" style="margin-top:10px;font-weight:bold;"></div>

 <h3>添加任务</h3>
 <input id="taskName" placeholder="任务名称" />
 <select id="mode">
   <option value="countdown">倒计时</option>
   <option value="timer">正计时</option>
 </select>
 <input id="duration" type="number" placeholder="时长（分钟）" />
 <button id="addTask">添加任务</button>
 <div id="taskList"></div>

 <h3>统计图表</h3>
 <canvas id="chartDaily"></canvas>
</div>

<div id="focusMode">专注中...</div>

<script>
// --- Firebase 配置 ---
const firebaseConfig = {
  apiKey: "AIzaSyDQkQFi2b0br4UemJP6Zhb-DckDx__pUs8",
  authDomain: "to-do-89a4f.firebaseapp.com",
  databaseURL: "https://to-do-89a4f-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "to-do-89a4f",
  storageBucket: "to-do-89a4f.firebasestorage.app",
  messagingSenderId: "894992095532",
  appId: "1:894992095532:web:06fb10726bb2dc5c643489",
  measurementId: "G-W8BWH3WB50"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = null;

// 登录
loginBtn.onclick = () => {
  const name = username.value.trim();
  if (!name) return alert("请输入名字");
  currentUser = name;
  userDisplay.innerText = "当前用户：" + name;
};

// 添加任务
addTask.onclick = () => {
  if (!currentUser) return alert("请先登录");
  const t = taskName.value.trim();
  const m = mode.value;
  const d = parseInt(duration.value);
  if (!t || !d) return alert("请填写完整信息");
  const id = Date.now();
  const task = { name: t, mode: m, duration: d };

  const div = document.createElement("div");
  div.className = "task";
  div.innerHTML = `<b>${t}</b> (${m === 'countdown' ? '倒计时' : '正计时'} ${d}分钟)
                   <button onclick="startFocus(${id}, '${t}', '${m}', ${d})">开始</button>`;
  taskList.appendChild(div);

  db.ref("tasks/" + currentUser + "/" + id).set(task);
};

// 专注模式
function startFocus(id, name, mode, duration) {
  focusMode.style.display = "block";
  const start = Date.now();
  let totalMs = duration * 60000;

  let timer = setInterval(() => {
    let passed = Date.now() - start;
    if (mode === "countdown") {
      if (passed >= totalMs) {
        clearInterval(timer);
        endFocus(duration);
      }
    }
  }, 1000);

  focusMode.onclick = () => {
    clearInterval(timer);
    let mins = Math.round((Date.now() - start) / 60000);
    endFocus(mins);
  };
}

function endFocus(mins) {
  focusMode.style.display = "none";
  if (!currentUser) return;
  const day = new Date().toISOString().slice(0, 10);
  db.ref("records/" + currentUser + "/" + day).transaction(v => (v || 0) + mins);
  alert("本次专注完成：" + mins + " 分钟");
  loadStats();
}

// 加载图表
function loadStats() {
  if (!currentUser) return;
  db.ref("records/" + currentUser).once("value", snap => {
    const data = snap.val() || {};
    const labels = Object.keys(data);
    const values = Object.values(data);
    new Chart(document.getElementById("chartDaily"), {
      type: "bar",
      data: { labels, datasets:[{ label:"专注时长(分钟)", data: values }] },
    });
  });
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- ... 前面的CSS样式保持不变 ... -->
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-clock"></i></div>
                <h1>时间管理与专注力工具</h1>
            </div>
            <div class="user-section">
                <div id="userInfo" class="user-info hidden"> <!-- 修改处1: 初始隐藏 -->
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div id="userName">用户</div>
                        <button id="logoutBtn" style="padding: 5px 10px; font-size: 12px;">退出登录</button>
                    </div>
                </div>
            </div>
        </header>
        
        <div id="loginPanel" class="login-panel"> <!-- 修改处2: 登录面板默认显示 -->
            <!-- ... 登录面板内容不变 ... -->
        </div>
        
        <div id="mainApp" class="hidden"> <!-- 修改处3: 主应用默认隐藏 -->
            <!-- ... 主应用内容不变 ... -->
        </div>
        
        <footer>
            <p>时间管理与专注力工具 &copy; 2023 | 专注于提升您的工作效率</p>
            <p style="font-size: 12px; margin-top: 5px;">使用本地存储保存您的专注记录 | 如需云端同步请配置Firebase</p>
        </footer>
    </div>

    <div id="notification" class="notification hidden"></div>

    <script>
        // 初始化变量
        let currentUser = null;
        let tasks = [];
        let currentTimer = null;
        let timerSeconds = 25 * 60;
        let timerRunning = false;
        let selectedSound = null;
        let focusSessions = [];
        
        // 从本地存储加载数据
        function loadFromLocalStorage() {
            const savedTasks = localStorage.getItem('focusTasks');
            const savedSessions = localStorage.getItem('focusSessions');
            
            if (savedTasks) {
                tasks = JSON.parse(savedTasks);
            }
            
            if (savedSessions) {
                focusSessions = JSON.parse(savedSessions);
            }
            
            // 修改处4: 检查是否有已保存的用户登录状态
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
            }
        }
        
        // 保存数据到本地存储
        function saveToLocalStorage() {
            localStorage.setItem('focusTasks', JSON.stringify(tasks));
            localStorage.setItem('focusSessions', JSON.stringify(focusSessions));
            
            // 修改处5: 保存用户登录状态
            if (currentUser) {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            } else {
                localStorage.removeItem('currentUser');
            }
        }
        
        // DOM元素
        const loginPanel = document.getElementById('loginPanel');
        const mainApp = document.getElementById('mainApp');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        const usernameInput = document.getElementById('usernameInput');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const taskList = document.getElementById('taskList');
        const emptyTaskState = document.getElementById('emptyTaskState');
        const addTaskForm = document.getElementById('addTaskForm');
        const timerDisplay = document.getElementById('timerDisplay');
        const startTimerBtn = document.getElementById('startTimerBtn');
        const stopTimerBtn = document.getElementById('stopTimerBtn'); // 修改处6: 修复变量名
        const presetButtons = document.querySelectorAll('.preset-btn');
        const customMinutes = document.getElementById('customMinutes');
        const noiseOptions = document.querySelectorAll('.noise-option');
        const notification = document.getElementById('notification');
        
        // 图表变量
        let dailyChart, weeklyChart, monthlyChart, taskDistributionChart;
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            // 从本地存储加载数据
            loadFromLocalStorage();
            
            // 修改处7: 检查用户登录状态，如果已登录则显示主应用
            if (currentUser) {
                // 更新UI
                userName.textContent = currentUser.name;
                userAvatar.textContent = currentUser.name.charAt(0).toUpperCase();
                
                // 切换显示
                loginPanel.classList.add('hidden');
                mainApp.classList.remove('hidden');
                userInfo.classList.remove('hidden');
            } else {
                // 确保登录面板可见
                loginPanel.classList.remove('hidden');
                mainApp.classList.add('hidden');
                userInfo.classList.add('hidden');
            }
            
            // 初始化图表
            initializeCharts();
            
            // 修改处8: 移除这里对updateUIState的调用，放到后面
            // updateUIState(); // 这行注释掉或删除
            
            // 事件监听
            loginBtn.addEventListener('click', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);
            addTaskForm.addEventListener('submit', handleAddTask);
            startTimerBtn.addEventListener('click', startTimer);
            stopTimerBtn.addEventListener('click', stopTimer);
            customMinutes.addEventListener('change', updateTimerDisplay);
            
            // 预设按钮事件
            presetButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    presetButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const minutes = parseInt(this.getAttribute('data-minutes'));
                    customMinutes.value = minutes;
                    updateTimerDisplay();
                });
            });
            
            // 白噪音选项事件
            noiseOptions.forEach(option => {
                option.addEventListener('click', function() {
                    noiseOptions.forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                    selectedSound = this.getAttribute('data-sound');
                    showNotification(`已切换白噪音: ${this.querySelector('div:last-child').textContent}`);
                });
            });
            
            // 设置默认白噪音
            noiseOptions[0].classList.add('active');
            selectedSound = noiseOptions[0].getAttribute('data-sound');
            
            // 初始更新计时器显示
            updateTimerDisplay();
            
            // 渲染任务列表
            renderTaskList();
            
            // 修改处9: 在这里初始化UI状态
            updateUIState();
        });
        
        // ... 中间的函数保持不变 ...
        
        // 处理登录
        function handleLogin() {
            const username = usernameInput.value.trim();
            if (!username) {
                showNotification('请输入您的名字', 'error');
                usernameInput.focus();
                return;
            }
            
            currentUser = {
                name: username,
                id: 'user-' + Date.now()
            };
            
            // 保存用户信息到本地存储
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // 更新UI
            userName.textContent = currentUser.name;
            userAvatar.textContent = currentUser.name.charAt(0).toUpperCase();
            
            // 切换显示
            loginPanel.classList.add('hidden');
            mainApp.classList.remove('hidden');
            userInfo.classList.remove('hidden');
            
            // 显示欢迎消息
            showNotification(`欢迎回来，${currentUser.name}！`, 'success');
            
            // 更新图表数据
            updateCharts();
        }
        
        // 处理退出登录
        function handleLogout() {
            // 停止计时器
            stopTimer();
            
            // 重置状态
            currentUser = null;
            
            // 从本地存储移除用户信息
            localStorage.removeItem('currentUser');
            
            // 切换显示
            loginPanel.classList.remove('hidden');
            mainApp.classList.add('hidden');
            userInfo.classList.add('hidden');
            
            // 重置用户名输入
            usernameInput.value = '';
            
            showNotification('您已退出登录', 'info');
        }
        
        // ... 中间的函数保持不变 ...
        
        // 开始计时器
        function startTimer() {
            if (timerRunning) {
                showNotification('计时器已经在运行中', 'info');
                return;
            }
            
            const minutes = parseInt(customMinutes.value) || 25;
            if (minutes < 1 || minutes > 180) {
                showNotification('时长应在1-180分钟之间', 'error');
                return;
            }
            
            timerSeconds = minutes * 60;
            timerRunning = true;
            
            // 更新按钮状态
            startTimerBtn.disabled = true;
            startTimerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 专注中...';
            stopTimerBtn.classList.remove('hidden'); // 修改处10: 显示停止按钮
            
            // 更新任务列表中的按钮状态
            document.querySelectorAll('.timer-btn.start').forEach(btn => {
                btn.disabled = true;
            });
            
            currentTimer = setInterval(() => {
                timerSeconds--;
                
                const displayMinutes = Math.floor(timerSeconds / 60);
                const displaySeconds = timerSeconds % 60;
                
                timerDisplay.textContent = 
                    `${displayMinutes.toString().padStart(2, '0')}:${displaySeconds.toString().padStart(2, '0')}`;
                
                // 时间到
                if (timerSeconds <= 0) {
                    stopTimer();
                    showNotification('专注时间结束！休息一下吧', 'success');
                    
                    // 保存专注记录
                    const minutesElapsed = minutes;
                    saveFocusSession(minutesElapsed);
                    
                    // 播放提示音
                    playTimerEndSound();
                }
            }, 1000);
            
            showNotification(`专注计时开始: ${minutes}分钟`, 'info');
        }
        
        // 停止计时器
        function stopTimer() {
            if (!timerRunning) return;
            
            timerRunning = false;
            if (currentTimer) {
                clearInterval(currentTimer);
            }
            
            // 更新按钮状态
            startTimerBtn.disabled = false;
            startTimerBtn.innerHTML = '<i class="fas fa-play"></i> 开始专注';
            stopTimerBtn.classList.add('hidden'); // 修改处11: 隐藏停止按钮
            
            // 更新任务列表中的按钮状态
            document.querySelectorAll('.timer-btn.start').forEach(btn => {
                btn.disabled = false;
            });
            
            // 保存专注记录（如果计时超过1分钟）
            const minutes = parseInt(customMinutes.value) || 25;
            const minutesElapsed = minutes - Math.ceil(timerSeconds / 60);
            if (minutesElapsed > 0) {
                saveFocusSession(minutesElapsed);
                showNotification(`专注完成: ${minutesElapsed}分钟`, 'success');
            } else {
                showNotification('专注已取消', 'info');
            }
        }
        
        // ... 其余函数保持不变 ...
        
        // 更新UI状态
        function updateUIState() {
            // 修改处12: 移除对stopTimerBtn的操作，因为已经在stopTimer函数中处理
            // 初始隐藏停止按钮 - 这行移除，改为在startTimer和stopTimer函数中控制
        }
    </script>
</body>
</html>

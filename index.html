<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä¸“æ³¨æ—¶é—´ç®¡ç†ç³»ç»Ÿ</title>

<!-- ========== å…¨å±€æ ·å¼ï¼Œæ›´ç¨³å®šå¯äº¤äº’ ========== -->
<style>
  body {
    margin: 0;
    font-family: "Segoe UI", sans-serif;
    background: #0f1218;
    color: #fff;
  }
  header {
    padding: 20px;
    text-align: center;
    font-size: 32px;
    font-weight: bold;
    background: #1a1f2b;
  }
  .container {
    max-width: 1000px;
    margin: auto;
    padding: 20px;
  }
  .card {
    background: #1f2533;
    padding: 20px;
    border-radius: 16px;
    margin-top: 20px;
  }
  input, select {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border-radius: 10px;
    border: none;
    background: #2a3142;
    color: #fff;
  }
  button {
    background: #4e8cff;
    padding: 12px 18px;
    border: none;
    border-radius: 10px;
    color: #fff;
    cursor: pointer;
    margin-top: 10px;
  }
  button:hover {
    background: #2e6ee8;
  }
  .task-item {
    background: #2a3142;
    padding: 15px;
    margin: 10px 0;
    border-radius: 10px;
    display: flex;
    justify-content: space-between;
  }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
</head>
<body>
<header>ğŸ”¥ é«˜çº§ä¸“æ³¨æ—¶é—´ç®¡ç†ç³»ç»Ÿ</header>
<div class="container">

<!-- ç™»å½•ç•Œé¢ -->
<div id="loginSection" class="card">
  <h2>ç™»å½•</h2>
  <input id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
  <button onclick="login()">è¿›å…¥ç³»ç»Ÿ</button>
</div>

<!-- ä¸»ç•Œé¢ï¼ˆé»˜è®¤éšè—ï¼‰ -->
<div id="mainSection" style="display:none;">

  <div class="card">
    <h2>æ·»åŠ ä»»åŠ¡</h2>
    <input id="taskName" placeholder="ä»»åŠ¡åç§°">
    <select id="taskMode">
      <option value="å€’è®¡æ—¶">å€’è®¡æ—¶</option>
      <option value="æ­£è®¡æ—¶">æ­£è®¡æ—¶</option>
    </select>
    <input id="taskMinutes" type="number" placeholder="åˆ†é’Ÿæ•°">
    <button onclick="addTask()">æ·»åŠ ä»»åŠ¡</button>
  </div>

  <div class="card">
    <h2>ä»»åŠ¡åˆ—è¡¨</h2>
    <div id="taskList"></div>
  </div>

  <div class="card" style="text-align:center;">
    <h2>è®¡æ—¶å™¨</h2>
    <h1 id="timerDisplay">0:00</h1>
  </div>

  <div class="card">
    <h2>ç™½å™ªéŸ³</h2>
    <select id="noiseSelect" onchange="changeNoise()">
      <option value="rain.mp3">é›¨å£°</option>
      <option value="forest.mp3">æ£®æ—</option>
      <option value="waves.mp3">æµ·æµª</option>
      <option value="wind.mp3">é£å£°</option>
      <option value="cafe.mp3">å’–å•¡åº—</option>
    </select>
    <audio id="noisePlayer" controls loop></audio>
  </div>
</div>
</div>

<audio id="endSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
// ========== Firebase é…ç½® ==========
const firebaseConfig = {
  apiKey: "AIzaSyDQkQFi2b0br4UemJP6Zhb-DckDx__pUs8",
  authDomain: "to-do-89a4f.firebaseapp.com",
  databaseURL: "https://to-do-89a4f-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "to-do-89a4f",
  storageBucket: "to-do-89a4f.firebasestorage.app",
  messagingSenderId: "894992095532",
  appId: "1:894992095532:web:06fb10726bb2dc5c643489",
  measurementId: "G-W8BWH3WB50"
};
const appFb = firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let username = "";
let timer = null;
let seconds = 0;

// ========== ç™»å½•è·³è½¬é€»è¾‘ï¼ˆä¿®å¤æ— æ³•è·³è½¬ï¼‰ ==========
function login() {
  const name = document.getElementById("username").value.trim();
  if (!name) {
    alert("è¯·è¾“å…¥ç”¨æˆ·å");
    return;
  }
  username = name;

  // é¡µé¢åˆ‡æ¢
  document.getElementById("loginSection").style.display = "none";
  document.getElementById("mainSection").style.display = "block";

  renderTasks();
}

// ========== æ·»åŠ ä»»åŠ¡ ==========
function addTask() {
  const name = document.getElementById("taskName").value;
  const mode = document.getElementById("taskMode").value;
  const minutes = document.getElementById("taskMinutes").value;

  if (!name) return alert("è¯·è¾“å…¥ä»»åŠ¡åç§°");

  const taskId = Date.now();

  db.ref(`users/${username}/tasks/${taskId}`).set({name, mode, minutes});

  renderTasks();
}

// ========== åˆ é™¤ä»»åŠ¡ ==========
function deleteTask(id) {
  db.ref(`users/${username}/tasks/${id}`).remove();
  renderTasks();
}

// ========== æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ ==========
function renderTasks() {
  const area = document.getElementById("taskList");
  area.innerHTML = "åŠ è½½ä¸­...";

  db.ref(`users/${username}/tasks`).once("value", snap => {
    area.innerHTML = "";

    snap.forEach(child => {
      const t = child.val();

      area.innerHTML += `
        <div class='task-item'>
          <div>
            <strong>${t.name}</strong><br>
            ${t.mode} - ${t.minutes} åˆ†é’Ÿ
          </div>
          <div>
            <button onclick="startTimer(${t.minutes * 60})">å¼€å§‹</button>
            <button onclick="deleteTask('${child.key}')" style="background:#ff5555;">åˆ é™¤</button>
          </div>
        </div>
      `;
    });
  });
}

// ========== å¯åŠ¨è®¡æ—¶ ==========
function startTimer(sec) {
  seconds = sec;
  clearInterval(timer);

  timer = setInterval(() => {
    seconds--;
    document.getElementById("timerDisplay").innerText = format(seconds);

    if (seconds <= 0) {
      clearInterval(timer);
      document.getElementById("endSound").play();
      saveFocusRecord();
    }
  }, 1000);
}

// ========== ä¿å­˜æ•°æ® ==========
function saveFocusRecord() {
  const day = new Date().toISOString().slice(0, 10);
  db.ref(`users/${username}/focus/${day}`).push({duration: seconds});
}

function format(sec) {
  let m = Math.floor(sec / 60);
  let s = sec % 60;
  return `${m}:${s.toString().padStart(2, "0")}`;
}

// ========== ç™½å™ªéŸ³æ’­æ”¾ ==========
function changeNoise() {
  const src = document.getElementById("noiseSelect").value;
  const player = document.getElementById("noisePlayer");
  player.src = src;
  player.play();
}
</script>
</body>
</html>
